<!doctype html>
<html>
<head>
<meta charset='UTF-8'><meta name='viewport' content='width=device-width initial-scale=1'>
<link rel='stylesheet' href='../../../plugins/googleapis/fonts.css'>
<link rel="stylesheet" href="../../../dist/css/markdown.css">
</head>
<body class='typora-export os-windows'><div class='typora-export-content'>
<div id='write'  class=''><blockquote><p><span>注：本靶场环境基于Python，以下内容根据PHP/Java/Python等WEB环境进行总结，部分内容可能不适用于本题。</span></p></blockquote><ul><li><p><strong><span>文件上传漏洞介绍</span></strong></p><p><span>文件上传漏洞，字如其意，就是可能出现在一切允许上传文件的功能点。</span></p><p><span>它是指由于程序员未对上传的文件进行严格的验证和过滤，而导致的用户可以越过其本身权限向服务器上上传可执行的动态脚本文件。这里上传的文件可以是木马，病毒，恶意脚本或者WebShell等。这种攻击方式是最为直接和有效的，“文件上传”本身没有问题，有问题的是文件上传后，服务器怎么处理、解释文件。如果服务器的处理逻辑做的不够安全，则会导致严重的后果。</span></p></li></ul><p></br></p><ul><li><p><strong><span>漏洞分类</span></strong></p><ol start='' ><li><p><span>前端绕过</span></p></li><li><p><span>后端绕过—后缀校验</span></p></li><li><p><span>后端绕过—黑白名单校验</span></p></li><li><p><span>后端绕过—文件类型校验</span></p></li><li><p><span>后端绕过—文件头检测</span></p></li><li><p><span>后端绕过—WAF绕过</span></p></li><li><p><span>其他绕过</span></p></li></ol></li></ul><p></br></p><ul><li><p><strong><span>漏洞产生原因</span></strong></p><ol start='' ><li><p><span>服务器配置不当</span></p></li><li><p><span>文件上传过滤缺陷</span></p></li><li><p><span>服务器权限管理不当</span></p></li><li><p><span>文件和服务器隔离不当</span></p></li><li><p><span>上传功能开发缺陷</span></p></li><li><p><span>开源编辑器或上传组件存在漏洞</span></p></li></ol></li></ul><p></br></p><ul><li><p><strong><span>文件上传漏洞利用条件</span></strong></p><ol start='' ><li><p><span>上传的文件能够被web容器解释执行</span></p></li><li><p><span>用户能够从web访问这个文件</span></p></li><li><p><span>上传的文件内容完整</span></p></li></ol></li></ul><p></br></p><ul><li><p><strong><span>文件上传漏洞利用点</span></strong></p><ol start='' ><li><p><span>允许上传脚本语言文件且解析 ==&gt; getshell</span></p></li><li><p><span>允许上传html ==&gt; xss、csrf、登陆劫持...</span></p></li><li><p><span>允许上传压缩包 ==&gt; 压缩包DOS、解压文件getshell</span></p></li><li><p><span>允许上传pdf ==&gt; pdf xss</span></p></li><li><p><span>允许上传swf ==&gt; swf xss</span></p></li><li><p><span>允许上传excel、docx ==&gt; xxe</span></p></li></ol></li></ul><p></br></p><ul><li><p><strong><span>测试流程</span></strong></p><p><span>图自：</span><a href='https://github.com/c0ny1/upload-labs/raw/master/doc/sum_up.png' target='_blank' class='url'>https://github.com/c0ny1/upload-labs/raw/master/doc/sum_up.png</a></p><p><img src="sum_up.png" referrerpolicy="no-referrer"></p></li></ul><p></br></p><ul><li><p><strong><span>上传绕过思路</span></strong></p><p><span>图自：</span><a href='https://github.com/c0ny1/upload-labs/blob/master/doc/mind-map.png' target='_blank' class='url'>https://github.com/c0ny1/upload-labs/blob/master/doc/mind-map.png</a></p><p><img src="mind-map.png" referrerpolicy="no-referrer"></p></li></ul><p></br></p><ul><li><p><strong><span>后端绕过之后缀替换</span></strong></p><figure><table><thead><tr><th><span>后缀</span></th><th><span>可替换（部分后缀为特定情况下可用）</span></th></tr></thead><tbody><tr><td><span>asp/aspx</span></td><td><span>asa,asax,ascx,ashx,asmx,cer,aSp,aSpx,aSa,aSax,aScx,aShx,aSmx,cEr</span></td></tr><tr><td><span>php</span></td><td><span>php5,php4,php3,php2,pHp,pHp5,pHp4,pHp3,pHp2,</span></td></tr><tr><td><span>jsp</span></td><td><span>jsp,jspa,jspx,jsw,jsv,jspf,jtml,jSp,jSpx,jSpa,jSw,jSv,jSpf</span></td></tr><tr><td><span>html</span></td><td><span>htm,phtml,pht,Html,Htm,pHtml,HTML,jHtml</span></td></tr></tbody></table></figure></li></ul><p></br></p><ul><li><p><strong><span>后端绕过之Content-Type介绍</span></strong></p><figure><table><thead><tr><th><span>文件类型</span></th><th><span>Content-type</span></th></tr></thead><tbody><tr><td><span>超文本标记语言文本</span></td><td><span>.html,.html text/html</span></td></tr><tr><td><span>普通文本</span></td><td><span>.txt text/plain</span></td></tr><tr><td><span>RTF文本</span></td><td><span>.txt text/plain</span></td></tr><tr><td><span>GIF图形</span></td><td><span>.gif image/gif</span></td></tr><tr><td><span>JPEG图形</span></td><td><span>.jpeg,.jpg image/jpeg</span></td></tr><tr><td><span>au声音文件</span></td><td><span>.au audio/basic</span></td></tr><tr><td><span>MIDI音乐文件</span></td><td><span>.mid,.midi audio/midi,audio/x-midi</span></td></tr><tr><td><span>RealAudio音乐文件</span></td><td><span>.ra, .ram audio/x-pn-realaudio</span></td></tr><tr><td><span>MPEG文件</span></td><td><span>.mpg,.mpeg video/mpeg</span></td></tr><tr><td><span>AVI文件</span></td><td><span>.avi video/x-msvideo</span></td></tr><tr><td><span>GZIP文件</span></td><td><span>.gz application/x-gzip</span></td></tr><tr><td><span>TAR文件</span></td><td><span>.tar application/x-tar</span></td></tr></tbody></table></figure></li></ul><p></br></p><ul><li><p><strong><span>后端绕过之文件头</span></strong></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.51562px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">.jpg &nbsp;  Value = FF D8 FF E0 </span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">.gif &nbsp;  Value = 47 49 46 38 ==&gt; GIF89a</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">.png &nbsp;  Value = 89 50 4E 47</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">.html &nbsp;  Value = 68 74 6D 6C 3E 10</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">.xml &nbsp;  Value = 3C 3F 78 6D 6C</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 115px;"></div><div class="CodeMirror-gutters" style="display: none; height: 115px;"></div></div></div></pre></li></ul><p></br></p><ul><li><p><strong><span>漏洞防御</span></strong></p><ol><li><p><span>后缀白名单，只允许上传jpg、jpeg、png、gif</span></p></li><li><p><span>内容完整性检测</span></p></li><li><p><span>文件和服务器分离</span></p></li><li><p><span>文件名加密，不暴露文件路径</span></p></li><li><p><span>使用安全的上传框架、组件</span></p></li><li><p><span>使用WAF拦截</span></p></li></ol></li></ul><p></br></p><ul><li><p><strong><span>推荐学习文章</span></strong></p><ol start='' ><li><p><a href='https://cloud.tencent.com/developer/article/1938541' target="_blank"><span>腾讯社区-超详细文件上传漏洞总结分析</span></a></p></li><li><p><a href='https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/02.web%E6%BC%8F%E6%B4%9E/08.%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/#%E4%BF%AE%E5%A4%8D%E5%BB%BA%E8%AE%AE' target="_blank"><span>d4m1ts知识库-文件上传</span></a></p></li><li><p><a href='https://blog.csdn.net/qinshuoyang1/article/details/125877345' target="_blank"><span>CSDN-web渗透之文件上传漏洞</span></a></p></li></ol></li></ul></div></div>
</body>
</html>